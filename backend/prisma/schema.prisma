// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  telegramId    String   @unique
  username      String?
  firstName     String?
  lastName      String?
  referredBy    String?
  referralChain String[] @default([])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  referrer User? @relation("ReferralChain", fields: [referredBy], references: [telegramId], onDelete: SetNull)
  referrals User[] @relation("ReferralChain")
  
  wallet      Wallet?
  deposits    Deposit[]
  withdrawals Withdrawal[]
  roiRecords  ROIRecord[]

  @@map("users")
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

model InvestmentPackage {
  id        String   @id @default(uuid())
  name      String
  minAmount Float
  maxAmount Float
  dailyROI  Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deposits Deposit[]

  @@map("investment_packages")
}

model Deposit {
  id              String    @id @default(uuid())
  userId          String
  packageId       String?
  amount          Float
  status          String    @default("PENDING") // PENDING, APPROVED, ACTIVE, REJECTED
  depositAddress String?   // Transaction hash or proof
  transactionProof String?  // Screenshot URL or additional proof
  approvedAt      DateTime?
  approvedBy      String?   // Admin user ID
  lastROIDate     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  package InvestmentPackage? @relation(fields: [packageId], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([status])
  @@map("deposits")
}

model Withdrawal {
  id             String    @id @default(uuid())
  userId         String
  amount         Float
  cryptoAddress  String    // User's crypto wallet address
  network        String?   // BEP20, ERC20, TRC20, etc.
  status         String    @default("PENDING") // PENDING, APPROVED, COMPLETED, REJECTED
  transactionHash String?  // Admin adds this after processing payment
  approvedAt     DateTime?
  approvedBy     String?   // Admin user ID
  completedAt    DateTime?
  rejectedAt     DateTime?
  rejectionReason String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("withdrawals")
}

model ROIRecord {
  id        String   @id @default(uuid())
  userId    String
  depositId String?
  amount    Float
  type      String   // 'SELF' or 'REFERRAL_LEVEL_1' to 'REFERRAL_LEVEL_10'
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("roi_records")
}

model SystemLog {
  id        String   @id @default(cuid())
  action    String
  userId    String?
  depositId String?
  amount    Float?
  status    String
  details   Json?
  error     String?
  createdAt DateTime @default(now())

  @@index([action, createdAt])
  @@index([userId])
  @@map("system_logs")
}

